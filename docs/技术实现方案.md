# 数学作业批改系统 - 技术实现方案

## 技术架构

### 整体架构
```
前端层 (HTML/CSS/JavaScript)
    ↓
业务逻辑层 (JavaScript模块)
    ↓
API接口层 (Moonshot Vision API)
```

### 核心模块
1. **Windows启动脚本**: Windows批处理文件(.bat)，双击启动
2. **图像获取模块**: 摄像头调用 + 图片上传
3. **图像识别模块**: Moonshot API集成
4. **OCR识别模块**: 文字和数学公式识别
5. **批改算法模块**: 答案比对和评分
6. **UI渲染模块**: Apple风格界面 + KaTeX公式渲染
7. **结果展示模块**: 批改结果页面渲染

## 技术选型

### 前端技术栈
- **HTML5**: 语义化结构
- **CSS3**: 毛玻璃效果、动画、响应式布局
- **JavaScript (ES6+)**: 模块化开发
- **KaTeX**: 数学公式渲染
- **Web API**: MediaDevices (摄像头)、File API

### 外部服务
- **Moonshot Vision API**: 图像识别和理解
  - 模型: `moonshot-v1-8k-vision-preview`
  - 功能: 识别学生姓名、提取题目和答案

### 开发工具
- 原生开发（无框架）
- 遵循奥卡姆剃刀原则

## 详细实现方案

### 1. Windows启动脚本

#### 脚本文件设计
为Windows用户提供的启动脚本：

1. **Windows批处理文件** (`start.bat`)

#### Windows启动脚本 (start.bat)
```batch
@echo off
chcp 65001 >nul
title 数学作业批改系统

echo 正在启动数学作业批改系统...
echo.

:: 获取脚本所在目录
set "SCRIPT_DIR=%~dp0"
set "SCRIPT_DIR=%SCRIPT_DIR:~0,-1%"

:: 检查是否存在index.html
if exist "%SCRIPT_DIR%\index.html" (
    echo ✓ 检测到系统文件
    echo 正在打开浏览器...
    start "" "%SCRIPT_DIR%\index.html"
    echo ✓ 系统已启动！
) else (
    echo 错误：未找到系统文件 index.html
    echo 请确保文件位于同一目录下。
    echo.
    pause
)

echo.
echo 按任意键关闭此窗口...
pause >nul
```

#### 增强版启动脚本（自动检测部署方式）

**start.bat (Windows) - 完整版**
```batch
@echo off
chcp 65001 >nul
title 数学作业批改系统

echo ==========================================
echo     数学作业批改系统 - 启动程序
echo ==========================================
echo.

:: 获取脚本所在目录
set "SCRIPT_DIR=%~dp0"
set "SCRIPT_DIR=%SCRIPT_DIR:~0,-1%"

echo [1/2] 正在检查系统文件...
echo.

:: 检查是否存在index.html
if exist "%SCRIPT_DIR%\index.html" (
    echo ✓ 检测到本地系统文件
    set "FILE_PATH=%SCRIPT_DIR%\index.html"
    set "DEPLOY_TYPE=local"
) else (
    echo ✓ 使用远程部署模式
    set "DEPLOY_TYPE=remote"
    set "FILE_PATH=https://your-domain.com"
)

echo.
echo [2/2] 正在启动系统...
echo.

:: 直接打开文件或URL
if "%DEPLOY_TYPE%"=="local" (
    echo 打开本地文件: %FILE_PATH%
    start "" "%FILE_PATH%"
) else (
    echo 打开远程地址: %FILE_PATH%
    start "" "%FILE_PATH%"
)

echo.
echo ==========================================
echo ✓ 系统已启动
echo ✓ 浏览器将自动打开
echo ==========================================
echo.
echo 按任意键关闭此窗口...
pause >nul
```


#### 创建桌面快捷方式（可选）

**Windows快捷方式批处理** (`create_shortcut.bat`)
```batch
@echo off
set "SCRIPT_DIR=%~dp0"
set "SHORTCUT_PATH=%USERPROFILE%\Desktop\数学作业批改系统.lnk"

echo 创建桌面快捷方式...

powershell -Command "$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%SHORTCUT_PATH%'); $Shortcut.TargetPath = '%SCRIPT_DIR%start.bat'; $Shortcut.WorkingDirectory = '%SCRIPT_DIR%'; $Shortcut.Description = '数学作业批改系统'; $Shortcut.Save()"

echo 桌面快捷方式创建完成！
pause
```

#### 使用说明
**Windows用户**：
- 双击 `start.bat` 启动
- 可选：运行 `create_shortcut.bat` 创建桌面快捷方式

#### 启动流程
```
用户双击启动文件
    ↓
自动检测系统文件或远程地址
    ↓
直接打开HTML文件或URL
    ↓
自动打开默认浏览器
    ↓
加载数学作业批改系统
```

#### 错误处理
- 未找到index.html：提示用户检查文件位置
- 文件路径错误：自动尝试重新定位
- 浏览器无法打开：提示用户手动打开
- 网络错误：显示详细错误信息

### 2. 图像获取模块

#### 摄像头拍照
```javascript
// 获取摄像头权限
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    video.srcObject = stream;
  });

// 拍照功能
function capturePhoto() {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  return canvas.toDataURL('image/png');
}
```

#### 图片上传
```javascript
// 文件选择和预览
function handleFileUpload(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = e => {
    previewImage.src = e.target.result;
  };
  reader.readAsDataURL(file);
}
```

### 3. 图像识别模块

#### Moonshot API集成
```javascript
import os
import base64
from openai import OpenAI

class ImageRecognizer:
    def __init__(self):
        self.client = OpenAI(
            api_key="sk-U9stsIdpW4JCP8knL5kbTRAh4RBvLNfjFQMjMnrirguTIFGY",
            base_url="https://api.moonshot.cn/v1",
        )

    def recognize_image(self, image_path, prompt):
        """识别图片内容"""
        with open(image_path, "rb") as f:
            image_data = f.read()

        image_url = f"data:image/{os.path.splitext(image_path)[1]};base64,{base64.b64encode(image_data).decode('utf-8')}"

        completion = self.client.chat.completions.create(
            model="moonshot-v1-8k-vision-preview",
            messages=[
                {"role": "system", "content": "你是Kimi，专业的数学作业批改助手。"},
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "image_url",
                            "image_url": {"url": image_url},
                        },
                        {
                            "type": "text",
                            "text": prompt,
                        },
                    ],
                },
            ],
        )
        return completion.choices[0].message.content

    def extract_student_name(self, image_path):
        """提取学生姓名"""
        prompt = "请仔细识别图片中的学生姓名，格式：姓名：XXX"
        return self.recognize_image(image_path, prompt)

    def extract_questions_and_answers(self, image_path):
        """提取题目和答案"""
        prompt = """请识别图片中的数学题目和答案，格式为JSON：
        {
          "questions": [
            {
              "number": 1,
              "question": "题目内容",
              "student_answer": "学生答案",
              "correct_answer": "正确答案",
              "score": 得分
            }
          ]
        }"""
        return self.recognize_image(image_path, prompt)
```

### 4. 批改算法模块

#### 答案比对逻辑
```javascript
class HomeworkGrader {
  grade(questions) {
    return questions.map(q => {
      const isCorrect = this.compareAnswers(
        q.student_answer,
        q.correct_answer
      );
      return {
        ...q,
        isCorrect,
        score: isCorrect ? q.fullScore : 0
      };
    });
  }

  compareAnswers(student, correct) {
    // 标准化答案（去除空格、转换格式）
    const normalize = ans => ans.replace(/\s+/g, '').toLowerCase();
    return normalize(student) === normalize(correct);
  }
}
```

### 5. UI渲染模块

#### Apple风格CSS框架
```css
/* 毛玻璃效果 */
.glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

/* 圆角卡片 */
.card {
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* 按钮样式 */
.btn {
  border-radius: 12px;
  padding: 12px 24px;
  font-weight: 600;
  transition: all 0.3s ease;
}

/* 流畅动画 */
.fade-in {
  animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
```

#### KaTeX集成
```javascript
// 渲染数学公式
function renderMath(element, latex) {
  try {
    katex.render(latex, element, {
      throwOnError: false,
      displayMode: true
    });
  } catch (e) {
    element.textContent = '公式渲染错误';
  }
}

// 批量渲染
function renderAllMath() {
  document.querySelectorAll('.math-formula').forEach(el => {
    const latex = el.dataset.latex;
    renderMath(el, latex);
  });
}
```

### 6. 结果展示模块

#### 批改结果页面设计
```html
<div class="result-container">
  <!-- 学生姓名 -->
  <div class="student-info card">
    <h2 id="studentName">学生姓名：张三</h2>
  </div>

  <!-- 题目列表 -->
  <div class="questions-list">
    <div class="question-item card">
      <div class="question-header">
        <span class="question-number">第1题</span>
      </div>
      <div class="question-content">
        <div class="label">题目：</div>
        <div class="math-formula" data-latex="x^2 + y^2 = z^2"></div>
      </div>
      <div class="answer-content">
        <div class="label">学生答案：</div>
        <div class="math-formula" data-latex="x^2 + y^2 = z^2"></div>
      </div>
      <div class="answer-content correct">
        <div class="label">正确答案：</div>
        <div class="math-formula" data-latex="x^2 + y^2 = z^2"></div>
      </div>
      <div class="result">
        <span class="status correct">✓ 正确</span>
        <span class="score">得分：10/10</span>
      </div>
    </div>
  </div>
</div>
```

#### 结果页面CSS样式
```css
.result-container {
  padding: 20px;
  max-width: 800px;
  margin: 0 auto;
}

.student-info {
  background: rgba(59, 130, 246, 0.1);
  padding: 20px;
  margin-bottom: 20px;
}

.student-info h2 {
  color: #1e40af;
  font-size: 24px;
  font-weight: 600;
}

.question-item {
  padding: 20px;
  margin-bottom: 16px;
  transition: transform 0.2s ease;
}

.question-item:hover {
  transform: translateY(-2px);
}

.question-header {
  margin-bottom: 12px;
}

.question-number {
  font-size: 18px;
  font-weight: 600;
  color: #374151;
}

.question-content,
.answer-content {
  margin: 12px 0;
  padding-left: 12px;
}

.answer-content.correct {
  background: rgba(34, 197, 94, 0.05);
  padding: 12px;
  border-radius: 8px;
  border-left: 4px solid #22c55e;
}

.label {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 8px;
  font-weight: 500;
}

.result {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #e5e7eb;
}

.status {
  font-size: 16px;
  font-weight: 600;
  padding: 4px 12px;
  border-radius: 20px;
}

.status.correct {
  background: rgba(34, 197, 94, 0.1);
  color: #16a34a;
}

.status.incorrect {
  background: rgba(239, 68, 68, 0.1);
  color: #dc2626;
}

.score {
  font-size: 18px;
  font-weight: 700;
  color: #1f2937;
}
```

## 页面实现

### 页面结构
```
index.html (主页面)
├── header (导航栏)
├── main (内容区)
│   ├── home-section (首页)
│   ├── camera-section (拍照页)
│   ├── upload-section (上传页)
│   └── result-section (结果页)
└── footer (状态栏)
```

### 核心功能流程
```
用户操作 → 图像获取 → API识别 → 结果展示 → 批改评分
```

## API设计

### 识别API
```javascript
// 识别学生姓名
POST /api/recognize/name
Body: { image: base64 }

// 识别题目和答案
POST /api/recognize/homework
Body: { image: base64 }

// 批改作业
POST /api/grade
Body: { answers: [...] }
```

## 部署方案

### 开发环境
- 本地HTTP服务器 (Live Server)
- 静态文件部署

### 生产环境
- 静态网站托管
- 或集成到现有教学系统

## 性能优化

### 图像优化
- 压缩图片大小
- 限制图片分辨率
- 转换为Base64

### 缓存策略
- API结果缓存
- 图片预加载

### 异步处理
- 非阻塞式API调用
- 进度条显示
- 后台处理

## 错误处理

### 常见错误
1. **摄像头权限被拒绝**: 提供手动上传选项
2. **API调用失败**: 重试机制 + 错误提示
3. **图片识别失败**: 手动输入备选方案
4. **网络连接失败**: 离线模式提示

### 用户体验优化
- 友好的错误提示
- 操作指引
- 进度反馈

## 安全考虑

### 数据安全
- 本地处理敏感信息
- API密钥环境变量存储
- 不上传学生隐私数据

### 权限管理
- 摄像头权限请求
- 文件访问权限
- 本地存储权限

## 测试策略

### 功能测试
- 摄像头调用测试
- 图片上传测试
- API识别测试
- 批改逻辑测试

### 兼容性测试
- 浏览器兼容性
- 设备兼容性
- 不同分辨率测试

### 性能测试
- 响应时间测试
- 内存使用测试
- 并发处理测试
