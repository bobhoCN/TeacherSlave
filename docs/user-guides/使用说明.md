# 数学作业批改系统 - 完整使用说明

## 📖 系统简介

数学作业批改系统是一个基于 AI 图像识别的智能批改工具，支持拍照或上传图片自动识别学生姓名、题目和答案，并进行自动评分。系统采用 Apple 风格设计，提供简洁美观的用户体验。

### 🎯 核心功能

- **📷 智能拍照**: 直接使用摄像头拍摄作业进行批改
- **📁 图片上传**: 支持拖拽或选择文件上传本地图片
- **👤 学生识别**: 智能识别学生姓名，支持 13 种识别模式
- **📝 题目识别**: 自动识别数学题目和答案
- **🧮 公式支持**: 支持数学公式渲染（KaTeX）
- **✅ 自动评分**: 基于答案正确性自动打分
- **📊 详细报告**: 显示每道题的批改详情和总分
- **🔒 本地运行**: 安全的本地代理服务，保护 API 密钥

---

## 🖥️ 系统要求

### 最低配置

| 项目 | 要求 |
|------|------|
| **操作系统** | Windows 7/8/10/11 |
| **Node.js** | v14.0 或更高版本 |
| **浏览器** | Chrome、Edge、Firefox 等现代浏览器 |
| **内存** | 4GB 以上 |
| **网络** | 稳定的互联网连接（用于 API 调用） |

### 推荐配置

| 项目 | 推荐 |
|------|------|
| **操作系统** | Windows 10/11 |
| **Node.js** | v18.x 或更高版本 |
| **浏览器** | Chrome 最新版 |
| **摄像头** | 720p 或更高分辨率 |
| **内存** | 8GB 以上 |

---

## 🚀 快速开始

### 第一次使用

#### 第一步：安装 Node.js

1. 访问 Node.js 官网：https://nodejs.org/
2. 下载 **LTS 版本**（推荐）
3. 运行安装程序，按提示完成安装
4. **重要**：安装完成后重启计算机
5. 验证安装：
   ```bash
   node --version
   npm --version
   ```

#### 第二步：启动系统

**最简单的方式（推荐）：**

1. 双击 **`启动数学作业批改系统.bat`**
2. 等待自动检查环境（首次使用会自动安装依赖）
3. 系统启动后浏览器会自动打开
4. 如果浏览器未自动打开，手动访问：http://localhost:3007

**其他启动方式：**

```bash
# 方式1：使用 npm
npm start

# 方式2：使用 npm run dev（开发模式）
npm run dev

# 方式3：直接运行 node
node server.js
```

#### 第三步：开始使用

系统启动后，浏览器将打开主页，提供两个选项：

- **📷 拍照批改**：使用摄像头拍摄作业
- **📁 上传图片**：上传本地图片文件

---

## 📋 详细使用步骤

### 步骤 1：启动系统

#### 使用启动脚本（推荐）

1. 双击 `启动数学作业批改系统.bat`
2. 系统会显示启动进度：
   ```
   [1/5] 检查Node.js环境...
   [2/5] 检查npm包管理器...
   [3/5] 检查项目目录...
   [4/5] 检查依赖包...
   [5/5] 启动服务器并打开浏览器...
   ```
3. 等待启动完成
4. 浏览器将自动打开主页

#### 手动启动

```bash
# 进入项目目录
cd /path/to/teacher-slave-math

# 安装依赖（首次使用或更新后）
npm install

# 启动服务器
npm start
```

然后访问：http://localhost:3007

### 步骤 2：获取作业

#### 方式 A：拍照批改 📷

1. 点击主页 **"📷 拍照批改"** 按钮
2. 浏览器会请求摄像头权限，点击**"允许"**
3. 看到摄像头画面后：
   - 将作业平整放置在摄像头前
   - 确保光线充足，避免反光
   - 调整角度使内容清晰可见
4. 点击 **"拍摄作业"** 按钮拍照
5. 系统自动跳转到批改进度页面

**💡 拍照技巧：**
- 确保作业平整，避免折叠
- 保持摄像头与作业平行
- 光线均匀，避免阴影
- 学生姓名和题目清晰可见

#### 方式 B：上传图片 📁

1. 点击主页 **"📁 上传图片"** 按钮
2. 选择上传方式：
   - **拖拽上传**：直接将图片拖到上传区域
   - **文件选择**：点击"选择文件"按钮选择图片
3. 支持的图片格式：**JPG**、**PNG**、**GIF**
4. 预览图片后，点击 **"开始批改"** 按钮
5. 系统跳转到批改进度页面

### 步骤 3：查看批改进度

系统会显示详细的批改进度，包含三个阶段：

#### 第一阶段：识别学生姓名

- 进度条从 0% 开始增长
- 正在使用 **13 种智能识别模式** 提取学生姓名
- 日志显示详细的识别过程
- 识别完成后显示学生姓名

#### 第二阶段：提取题目内容

- 进度条继续增长
- 识别题目和答案
- 支持数学公式识别
- 显示识别到的题目数量

#### 第三阶段：批改评分

- 进度条达到 100%
- 自动比对答案
- 计算每题得分
- 计算总分

### 步骤 4：查看批改结果

批改完成后，系统显示详细结果：

#### 学生信息区
- **学生姓名**：显示识别到的学生姓名
- **批改时间**：显示批改完成时间

#### 题目详情区
每道题显示：
- **题目内容**：题目原文（支持数学公式渲染）
- **学生答案**：学生作答
- **正确答案**：正确答案
- **对错状态**：✅ 正确 或 ❌ 错误
- **得分**：得分/总分

#### 数学公式支持
系统使用 KaTeX 渲染数学公式，支持：
- **分数**：$\frac{1}{2}$、$\frac{a}{b}$
- **指数**：$x^2$、$x^{10}$
- **根号**：$\sqrt{2}$、$\sqrt[3]{8}$
- **积分**：$\int_0^1 x dx$
- **求和**：$\sum_{i=1}^n i$
- **希腊字母**：$\alpha$、$\beta$、$\gamma$

---

## 🔧 高级功能

### 学生姓名识别（13 种模式）

系统采用 13 种智能识别模式，确保姓名识别准确性：

1. **明确标注**：从"姓名："、"学生："、"name："等标注中提取
2. **自我表述**：从"我叫"、"我是"、"我的名字是"中提取
3. **作业标注**：从"XXX的作业"、"XXX同学"中提取
4. **行首识别**：识别行首的 2-4 个汉字
5. **冒号后识别**：从"XXX: 张三"格式中提取
6. **前后空格**：查找有前后空格的 2-4 个汉字
7. **圆括号**：提取"(张三)"格式的姓名
8. **方括号**：提取"[张三]"格式的姓名
9. **姓名栏**：从"学生姓名："等栏位标识中提取
10. **横线填空**：识别姓名栏横线上方的文字
11. **顶部居中**：识别顶部居中的姓名
12. **下划线**：识别"_____"上方的姓名
13. **智能匹配**：通过候选姓名列表选择最可能的结果

### 进度条优化

系统采用均衡增长的进度条设计：
- **从 0% 开始**：视觉上更直观
- **三个阶段**：姓名识别 → 题目提取 → 批改评分
- **实时更新**：每个子任务完成后立即更新
- **详细日志**：显示每个识别模式的执行情况

### 摄像头操作

在浏览器控制台中可以使用高级功能：

```javascript
// 切换摄像头（前置/后置）
switchCamera();

// 获取摄像头状态
getCameraStatus();

// 重新初始化摄像头
initCamera();
```

### 代理服务状态检查

```javascript
// 检查代理服务是否在线
checkProxyStatus().then(status => {
    console.log(status ? '服务在线' : '服务离线');
});
```

---

## ❓ 常见问题解答

### Q1: 提示"未检测到 Node.js"

**原因**：系统中未安装 Node.js 或环境变量未生效

**解决方案**：
1. 访问 https://nodejs.org/ 下载并安装 Node.js
2. 选择 **LTS 版本**（长期支持版）
3. 安装完成后**重启计算机**
4. 验证安装：
   ```bash
   node --version
   ```
   应该显示版本号（如 v18.17.0）

### Q2: 端口 3007 被占用

**原因**：端口已被其他程序占用

**解决方案**：
1. **方法1**：使用启动脚本，选择 `Y` 强制启动
2. **方法2**：停止占用端口的程序：
   ```bash
   # 查找占用端口的进程
   netstat -ano | findstr :3007

   # 终止进程（将 PID 替换为实际进程ID）
   taskkill /PID <进程ID> /F
   ```
3. **方法3**：双击运行 `停止数学作业批改系统.bat`

### Q3: 摄像头无法启动

**原因**：摄像头权限被拒绝或驱动程序问题

**解决方案**：
1. **检查权限**：
   - 允许浏览器访问摄像头
   - 在浏览器地址栏旁查看摄像头图标，点击允许
2. **重启浏览器**：关闭所有浏览器窗口，重新打开
3. **检查驱动**：
   - 打开设备管理器
   - 查看摄像头设备是否正常
   - 更新摄像头驱动程序
4. **释放占用**：
   - 关闭其他可能使用摄像头的程序（微信、QQ 等）

### Q4: 依赖安装失败

**原因**：网络问题或 npm 配置问题

**解决方案**：
1. **检查网络**：确保能访问互联网
2. **切换 npm 镜像源**：
   ```bash
   npm config set registry https://registry.npmmirror.com
   ```
3. **清理缓存**：
   ```bash
   npm cache clean --force
   npm install
   ```
4. **使用管理员权限**：右键点击命令提示符，选择"以管理员身份运行"

### Q5: 识别失败或准确率低

**原因**：图片质量差、光线不足或格式问题

**解决方案**：
1. **提高图片质量**：
   - 使用高分辨率摄像头（720p 以上）
   - 确保光线充足且均匀
   - 避免反光和阴影
2. **优化拍摄角度**：
   - 摄像头与作业保持平行
   - 避免倾斜角度拍摄
3. **确保内容清晰**：
   - 学生姓名书写工整
   - 题目和答案清晰可见
   - 避免模糊或重影
4. **使用上传功能**：如果拍照效果差，可尝试扫描后上传

### Q6: 页面显示空白或加载失败

**原因**：代理服务未启动或浏览器缓存问题

**解决方案**：
1. **确认服务状态**：
   - 查看命令行窗口是否显示服务器日志
   - 访问 http://localhost:3007/api/health 检查服务状态
2. **清除缓存**：
   - 按 Ctrl+F5 强制刷新
   - 或清除浏览器缓存
3. **检查控制台错误**：
   - 按 F12 打开开发者工具
   - 查看 Console 选项卡的错误信息
4. **尝试其他浏览器**：Chrome、Edge、Firefox

### Q7: 数学公式无法显示

**原因**：KaTeX 库加载失败或网络问题

**解决方案**：
1. **检查网络**：确保能访问 CDN
2. **手动刷新**：等待 KaTeX 加载完成
3. **查看控制台**：检查是否有 KaTeX 相关错误
4. **切换网络**：尝试连接其他网络

### Q8: API 调用失败

**原因**：网络连接问题或 API 服务异常

**解决方案**：
1. **检查网络**：确保互联网连接正常
2. **检查防火墙**：确保未阻止程序访问网络
3. **查看服务器日志**：检查是否有错误信息
4. **重启服务**：重新启动代理服务

---

## 🛠️ 高级配置

### 手动操作

#### 启动代理服务

```bash
# 进入项目目录
cd /path/to/teacher-slave-math

# 安装依赖
npm install

# 启动服务
npm start

# 或开发模式（自动重启）
npm run dev
```

#### 检查服务状态

```bash
# 检查服务是否运行
curl http://localhost:3007/api/health

# 应该返回：
# {"status":"ok","message":"服务器运行正常"}
```

#### 查看服务日志

服务器启动后会显示详细日志：
- 姓名识别过程
- 题目提取结果
- API 调用日志
- 错误信息

### 停止服务

**方法1**：使用停止脚本
- 双击 `停止数学作业批改系统.bat`

**方法2**：在命令行中停止
- 在服务器命令行窗口按 `Ctrl+C`

**方法3**：强制终止进程
```bash
# 查找进程
tasklist | findstr node

# 终止进程
taskkill /IM node.exe /F
```

### 自定义端口

如果需要使用其他端口，可以修改 `server.js`：

```javascript
const PORT = 3007; // 改为你想要的端口号
```

然后重启服务。

---

## 🔒 隐私与安全

### 数据保护

- ✅ **图片处理**：所有图片仅用于识别，不会保存到服务器
- ✅ **临时使用**：识别完成后立即删除图片数据
- ✅ **本地存储**：批改结果不保存，仅在当前页面显示
- ✅ **会话隔离**：每次批改独立处理，不关联

### API 安全

- ✅ **密钥保护**：API 密钥仅存储在本地代理服务中
- ✅ **本地监听**：代理服务器仅监听 127.0.0.1（本地回环）
- ✅ **不暴露公网**：外部网络无法访问本地服务
- ✅ **无持久化**：API 密钥不写入任何配置文件

### 网络安全

- ✅ **CORS 配置**：仅允许本地前端访问 API
- ✅ **请求限制**：对请求大小和频率进行限制
- ✅ **输入验证**：对上传文件进行严格验证
- ✅ **错误处理**：避免泄露敏感信息

---

## 📁 项目结构

```
数学作业批改系统/
├── 启动数学作业批改系统.bat      # 🚀 Windows一键启动脚本
├── 停止数学作业批改系统.bat      # 🛑 停止服务器脚本
├── 使用说明.md                   # 📖 本文档
├── index.html                    # 🎨 主页面
├── server.js                     # 🔧 后端代理服务器
├── package.json                  # 📦 Node.js 配置
├── README.md                     # 📄 项目说明
├── USAGE.md                      # 📘 快速使用指南
├── 使用说明.txt                  # 📝 简版使用说明
├── test_*.html                   # 🧪 测试页面
│   ├── test_name.html            # 学生姓名识别测试
│   ├── test_grader.html          # 批改功能测试
│   └── test_upload.html          # 文件上传测试
├── assets/                       # 🎨 静态资源
│   ├── css/
│   │   └── style.css            # Apple风格样式
│   └── js/
│       ├── main.js              # 主要逻辑和页面切换
│       ├── camera.js            # 摄像头功能
│       ├── recognizer.js        # 图像识别
│       └── grader.js            # 批改评分
├── docs/                         # 📚 项目文档
│   ├── 需求分析.md
│   └── 技术实现方案.md
└── node_modules/                 # 📦 依赖包目录
```

---

## 📡 API 文档

### 基础信息

- **基础URL**：`http://localhost:3007/api`
- **内容类型**：`application/json`
- **字符编码**：`UTF-8`

### 端点列表

#### 1. 健康检查

```http
GET /api/health
```

**响应示例：**
```json
{
  "status": "ok",
  "message": "服务器运行正常"
}
```

#### 2. 识别学生姓名

```http
POST /api/recognize/name
Content-Type: multipart/form-data

参数：
- image: 图片文件（必需）
```

**响应示例：**
```json
{
  "success": true,
  "name": "张三",
  "confidence": 0.95,
  "mode": "模式1: 姓名标注"
}
```

#### 3. 识别题目和答案

```http
POST /api/recognize/questions
Content-Type: multipart/form-data

参数：
- image: 图片文件（必需）
```

**响应示例：**
```json
{
  "success": true,
  "questions": [
    {
      "id": 1,
      "question": "1+1=?",
      "studentAnswer": "2",
      "correctAnswer": "2",
      "isCorrect": true,
      "score": 5,
      "totalScore": 5
    }
  ],
  "totalScore": 5,
  "totalQuestions": 1
}
```

### 错误响应

**标准错误格式：**
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述"
  }
}
```

**常见错误码：**

| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| `NO_IMAGE` | 未提供图片 | 确保上传了图片文件 |
| `INVALID_IMAGE` | 图片格式不支持 | 使用 JPG、PNG 或 GIF 格式 |
| `API_ERROR` | API 调用失败 | 检查网络连接和 API 密钥 |
| `RECOGNITION_FAILED` | 识别失败 | 提高图片质量或重试 |
| `SERVER_ERROR` | 服务器内部错误 | 查看服务器日志并重启服务 |

---

## 🔄 更新日志

### v1.0.0 (2025-11-15)

**新增功能：**
- ✨ Windows 一键启动脚本
- ✨ 姓名识别优化，支持 13 种识别模式
- ✨ 批改进度条从 0 开始均衡增长
- ✨ 增加题目批改详细信息
- ✨ Apple 风格 UI 界面
- ✨ 数学公式渲染支持（KaTeX）

**问题修复：**
- 🔧 修复评分页面对错符号显示两个的问题
- 🔧 修复浅色字体问题
- 🔧 优化浅色字体显示

**技术改进：**
- 🚀 使用 Moonshot Vision API 进行图像识别
- 🔒 增强 API 安全性
- 📊 优化进度条显示逻辑
- 🎨 升级为 Apple 风格设计

### 未来计划

- [ ] 支持批量批改多张作业
- [ ] 添加批改历史记录功能
- [ ] 支持 Excel 导出批改结果
- [ ] 添加离线模式（本地识别）
- [ ] 优化移动端适配
- [ ] 添加语音播报功能

---

## 📞 技术支持

### 获取帮助

如果遇到问题，请按以下步骤排查：

1. **查看本文档**：首先查阅常见问题解答
2. **检查控制台**：按 F12 打开开发者工具，查看 Console 选项卡
3. **查看服务器日志**：观察命令行窗口中的日志信息
4. **重启服务**：尝试重新启动系统

### 故障排除流程

```
1. 环境检查
   ├─ [ ] Windows 版本兼容
   ├─ [ ] Node.js 已安装且版本 >= 14
   ├─ [ ] 网络连接正常
   └─ [ ] 浏览器支持

2. 服务检查
   ├─ [ ] 端口 3007 未被占用
   ├─ [ ] 代理服务启动成功
   ├─ [ ] 防火墙未阻止
   └─ [ ] API 可正常访问

3. 功能检查
   ├─ [ ] 摄像头权限已授权
   ├─ [ ] 图片格式正确
   ├─ [ ] 图片质量良好
   └─ [ ] 网络连接稳定

4. 日志分析
   ├─ [ ] 查看浏览器控制台错误
   ├─ [ ] 查看服务器启动日志
   ├─ [ ] 分析错误信息
   └─ [ ] 记录操作步骤
```

### 提交问题反馈

如果问题无法解决，请提供以下信息：

1. **错误现象**：详细描述问题现象
2. **操作步骤**：完整的操作流程
3. **环境信息**：
   - Windows 版本
   - Node.js 版本
   - 浏览器版本
4. **错误日志**：控制台和服务器日志
5. **截图**：错误页面或问题现象截图

---

## 📚 相关资源

### 官方文档

- **Node.js 官网**：https://nodejs.org/
- **Moonshot API 文档**：https://platform.moonshot.cn/
- **KaTeX 文档**：https://katex.org/
- **Express 文档**：https://expressjs.com/

### 第三方资源

- **npm 官网**：https://www.npmjs.com/
- **Chrome 开发者工具**：https://developer.chrome.com/docs/devtools/
- **Markdown 语法指南**：https://markdown.com.cn/

### 学习资源

- **JavaScript 教程**：https://developer.mozilla.org/zh-CN/docs/Web/JavaScript
- **Node.js 入门**：https://nodejs.org/zh-cn/learn/
- **Express 教程**：https://expressjs.com/zh-cn/starter/installing.html

---

## 📄 许可证

本项目采用 **MIT 许可证**，详情请查看 [LICENSE](LICENSE) 文件。

```
MIT License

Copyright (c) 2025 数学作业批改系统

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction...
```

---

## 🤝 贡献指南

欢迎社区贡献！请遵循以下步骤：

### 贡献流程

1. **Fork** 本项目
2. 创建特性分支：`git checkout -b feature/your-feature`
3. 提交更改：`git commit -am 'Add some feature'`
4. 推送分支：`git push origin feature/your-feature`
5. 提交 **Pull Request**

### 贡献方向

- 🐛 修复 Bug
- ✨ 新增功能
- 📚 完善文档
- 🎨 优化界面
- 🧪 添加测试
- 🌐 国际化支持

---

## 🙏 致谢

感谢以下开源项目和服务：

- **Node.js** - 服务器运行时
- **Express** - Web 框架
- **Moonshot AI** - 视觉识别 API
- **KaTeX** - 数学公式渲染
- **Apple** - 设计灵感

---

**开发者**：数学老师团队
**版本**：v1.0.0
**最后更新**：2025-11-15

**祝您使用愉快！** 🎉
